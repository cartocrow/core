<?php
  /*
  Copyright 2019 Netherlands eScience Center and TU Eindhoven
  Licensed under the Apache License, version 2.0. See LICENSE for details.
  */

  $json = file_get_contents('php://input');
  $data = json_decode($json);

  // Make sure that the temporary directory exists.
  $tmp = sys_get_temp_dir();
  $tmpdir = "$tmp/geoviz/";
  if (!file_exists($tmpdir))
    mkdir($tmpdir);

  // Store the geometry and data files in the temporary directory.
  $geometry_tmp = tempnam($tmpdir, "geom");

  $handle = fopen($geometry_tmp, "w");
  fwrite($handle, base64_decode($data->geometry_base64));
  fclose($handle);

  $exec = "../@CMAKE_INSTALL_BINARY_DIR@/@CURRENT_CLA@";
  $args =
    " --in_geometry_filename $geometry_tmp".
    " --log_dir $tmpdir".
    " --minloglevel=2";
  $command = escapeshellcmd("$exec $args");
  $result = shell_exec($command);
  echo $result;

  unlink($geometry_tmp);
?>
